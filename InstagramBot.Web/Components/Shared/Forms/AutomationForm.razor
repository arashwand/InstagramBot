@using InstagramBot.Application.Services.Interfaces
@using InstagramBot.DTOs
@inject IAutoReplyService AutoReplyService
@inject NavigationManager Navigation
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthState

<h3>تنظیمات اتوماسیون پاسخ</h3>

<EditForm Model="@automationRule" OnValidSubmit="SaveAutomationRule">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="accountId" class="form-label">شناسه حساب</label>
        <InputNumber id="accountId" @bind-Value="automationRule.AccountId" class="form-control" placeholder="شناسه حساب" />
        <ValidationMessage For="@(() => automationRule.AccountId)" />
    </div>

    <div class="mb-3">
        <label for="keyword" class="form-label">کلمه کلیدی (با کاما جدا کنید)</label>
        <InputText id="keyword" @bind-Value="keywordsInput" class="form-control" placeholder="کلمه کلیدی برای پاسخ" />
        <ValidationMessage For="@(() => keywordsInput)" />
    </div>

    <div class="mb-3">
        <label for="response" class="form-label">پاسخ</label>
        <InputTextArea id="response" @bind-Value="automationRule.Response" class="form-control" rows="3" placeholder="پاسخ خودکار" />
        <ValidationMessage For="@(() => automationRule.Response)" />
    </div>

    <div class="mb-3">
        <label for="isActive" class="form-label">فعال</label>
        <InputCheckbox id="isActive" @bind-Value="automationRule.IsActive" />
    </div>

    <button type="submit" class="btn btn-primary">ذخیره</button>
    <button type="button" class="btn btn-secondary ms-2" @onclick="Cancel">لغو</button>
</EditForm>

@if (automationRules.Any())
{
    <h4 class="mt-4">قوانین موجود</h4>
    <ul class="list-group">
        @foreach (var rule in automationRules)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                @string.Join(", ", rule.Keywords) - @rule.Response
                <span class="badge @(rule.IsActive ? "bg-success" : "bg-secondary")">@(rule.IsActive ? "فعال" : "غیرفعال")</span>
            </li>
        }
    </ul>
}

@code {
    private AutomationRuleDto automationRule = new();
    private List<AutomationRuleDto> automationRules = new();
    private int currentUserId;
    private string keywordsInput = ""; // ویژگی کمکی برای ورودی

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState.GetAuthenticationStateAsync();
        var user = authState.User;
        var userIdClaim = user.FindFirst("sub")?.Value ?? user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(userIdClaim, out int userId))
        {
            currentUserId = userId;
            await LoadAutomationRules();
        }
        else
        {
            // مدیریت خطا: کاربر لاگین نیست
            Navigation.NavigateTo("/login");
        }
    }

    private async Task LoadAutomationRules()
    {
        automationRules = await AutoReplyService.GetAllRulesAsync(currentUserId);
    }

    private async Task SaveAutomationRule()
    {
        // تبدیل رشته ورودی به لیست
        automationRule.Keywords = keywordsInput.Split(',', StringSplitOptions.RemoveEmptyEntries)
            .Select(k => k.Trim())
            .ToList();

        await AutoReplyService.CreateRuleAsync(automationRule, currentUserId);
        automationRule = new(); // ریست فرم
        keywordsInput = ""; // ریست ورودی
        await LoadAutomationRules();
    }

    private void Cancel()
    {
        automationRule = new();
        keywordsInput = "";
    }
}