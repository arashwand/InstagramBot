@page "/dashboard"
@using InstagramBot.DTOs
@using InstagramBot.Application.Services.Interfaces
@using Microsoft.AspNetCore.SignalR.Client
@inject IAnalyticsService AnalyticsService
@inject IPostService PostService
@inject IActivityService ActivityService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>داشبورد - ربات اینستاگرام</PageTitle>

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-tachometer-alt me-2"></i>
            داشبورد
        </h1>
        <div class="dashboard-actions">
            <button class="btn btn-primary" @onclick="RefreshData">
                <i class="fas fa-sync-alt me-1"></i>
                بروزرسانی
            </button>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-calendar me-1"></i>
                    @selectedPeriod
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" @onclick="() => ChangePeriod('امروز')">امروز</a></li>
                    <li><a class="dropdown-item" @onclick="() => ChangePeriod('هفته گذشته')">هفته گذشته</a></li>
                    <li><a class="dropdown-item" @onclick="() => ChangePeriod('ماه گذشته')">ماه گذشته</a></li>
                    <li><a class="dropdown-item" @onclick="() => ChangePeriod('سه ماه گذشته')">سه ماه گذشته</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- آمار کلیدی -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon bg-primary">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@dashboardStats.TotalAccounts.ToString("N0")</div>
                <div class="stat-label">اکانت‌های فعال</div>
                <div class="stat-change @(dashboardStats.AccountsChange >= 0 ? "positive" : "negative")">
                    <i class="fas @(dashboardStats.AccountsChange >= 0 ? "fa-arrow-up" : "fa-arrow-down")"></i>
                    @Math.Abs(dashboardStats.AccountsChange)%
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-success">
                <i class="fas fa-images"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@dashboardStats.TotalPosts.ToString("N0")</div>
                <div class="stat-label">پست‌های منتشر شده</div>
                <div class="stat-change @(dashboardStats.PostsChange >= 0 ? "positive" : "negative")">
                    <i class="fas @(dashboardStats.PostsChange >= 0 ? "fa-arrow-up" : "fa-arrow-down")"></i>
                    @Math.Abs(dashboardStats.PostsChange)%
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-info">
                <i class="fas fa-heart"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@dashboardStats.TotalLikes.ToString("N0")</div>
                <div class="stat-label">کل لایک‌ها</div>
                <div class="stat-change @(dashboardStats.LikesChange >= 0 ? "positive" : "negative")">
                    <i class="fas @(dashboardStats.LikesChange >= 0 ? "fa-arrow-up" : "fa-arrow-down")"></i>
                    @Math.Abs(dashboardStats.LikesChange)%
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon bg-warning">
                <i class="fas fa-comments"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@dashboardStats.TotalComments.ToString("N0")</div>
                <div class="stat-label">کل کامنت‌ها</div>
                <div class="stat-change @(dashboardStats.CommentsChange >= 0 ? "positive" : "negative")">
                    <i class="fas @(dashboardStats.CommentsChange >= 0 ? "fa-arrow-up" : "fa-arrow-down")"></i>
                    @Math.Abs(dashboardStats.CommentsChange)%
                </div>
            </div>
        </div>
    </div>

    <!-- نمودارها -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>
                    روند تعاملات
                </h5>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ExportEngagementChart">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="engagementChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-user-plus me-2"></i>
                    رشد فالوورها
                </h5>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ExportFollowersChart">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="followersChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- جداول اطلاعاتی -->
    <div class="tables-grid">
        <!-- پست‌های برتر -->
        <div class="table-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-star me-2"></i>
                    پست‌های برتر
                </h5>
                <a href="/posts/analytics" class="btn btn-sm btn-outline-primary">
                    مشاهده همه
                </a>
            </div>
            <div class="card-body">
                @if (topPosts.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>پست</th>
                                    <th>اکانت</th>
                                    <th>لایک</th>
                                    <th>کامنت</th>
                                    <th>تاریخ</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var post in topPosts.Take(5))
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                @if (!string.IsNullOrEmpty(post.ThumbnailUrl))
                                                {
                                                    <img src="@post.ThumbnailUrl" alt="Post" class="post-thumbnail me-2">
                                                }
                                                <div>
                                                    <div class="post-caption">@(post.Caption.Length > 50 ? post.Caption.Substring(0, 50) + "..." : post.Caption)</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>@post.AccountName</td>
                                        <td>
                                            <span class="badge bg-danger">
                                                <i class="fas fa-heart me-1"></i>
                                                @post.LikesCount.ToString("N0")
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">
                                                <i class="fas fa-comment me-1"></i>
                                                @post.CommentsCount.ToString("N0")
                                            </span>
                                        </td>
                                        <td>@post.PublishedAt.ToString("yyyy/MM/dd")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-images fa-2x mb-2"></i>
                        <div>هنوز پستی منتشر نشده است</div>
                    </div>
                }
            </div>
        </div>

        <!-- پست‌های زمان‌بندی شده -->
        <div class="table-card">
            <div class="card-header">
                <h5 class="card-title">
                    <i class="fas fa-clock me-2"></i>
                    پست‌های زمان‌بندی شده
                </h5>
                <a href="/posts" class="btn btn-sm btn-outline-primary">
                    مشاهده همه
                </a>
            </div>
            <div class="card-body">
                @if (scheduledPosts.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>پست</th>
                                    <th>اکانت</th>
                                    <th>زمان انتشار</th>
                                    <th>وضعیت</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var post in scheduledPosts.Take(5))
                                {
                                    <tr>
                                        <td>
                                            <div class="post-caption">@(post.Caption.Length > 50 ? post.Caption.Substring(0, 50) + "..." : post.Caption)</div>
                                        </td>
                                        <td>@post.AccountUsername</td>
                                        <td>@post.ScheduledDate.ToString("yyyy/MM/dd HH:mm")</td>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(post.Status)">
                                                @GetStatusText(post.Status)
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-plus fa-2x mb-2"></i>
                        <div>پست زمان‌بندی شده‌ای وجود ندارد</div>
                        <a href="/posts/schedule" class="btn btn-primary btn-sm mt-2">
                            زمان‌بندی پست جدید
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- فعالیت‌های اخیر -->
    <div class="activity-card">
        <div class="card-header">
            <h5 class="card-title">
                <i class="fas fa-history me-2"></i>
                فعالیت‌های اخیر
            </h5>
        </div>
        <div class="card-body">
            @if (recentActivities.Any())
            {
                <div class="activity-timeline">
                    @foreach (var activity in recentActivities.Take(10))
                    {
                        <div class="activity-item">
                            <div class="activity-icon @GetActivityIconClass(activity.Type)">
                                <i class="fas @GetActivityIcon(activity.Type)"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-message">@activity.Message</div>
                                <div class="activity-time">@activity.CreatedAt.ToString("yyyy/MM/dd HH:mm")</div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center text-muted py-4">
                    <i class="fas fa-history fa-2x mb-2"></i>
                    <div>فعالیت اخیری وجود ندارد</div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private DashboardStatsDto dashboardStats = new();
    private List<TopPostDto> topPosts = new();
    private List<ScheduledPostDto> scheduledPosts = new();
    private List<ActivityDto> recentActivities = new();
    private string selectedPeriod = "هفته گذشته";
    private HubConnection? analyticsHubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
        await InitializeSignalR();
        await InitializeCharts();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            dashboardStats = await AnalyticsService.GetDashboardStatsAsync(selectedPeriod);
            topPosts = await AnalyticsService.GetTopPostsAsync(10);
            scheduledPosts = await PostService.GetScheduledPostsAsync(10);
            recentActivities = await ActivityService.GetRecentActivitiesAsync(10);
        }
        catch (Exception ex)
        {
            // مدیریت خطا
            dashboardStats = new DashboardStatsDto { TotalAccounts = 0, TotalPosts = 0, TotalLikes = 0, TotalComments = 0 };
        }
    }

    private async Task InitializeSignalR()
    {
        analyticsHubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/analyticsHub"))
            .Build();

        analyticsHubConnection.On<object>("ReceiveAnalyticsUpdate", async (data) =>
        {
            await LoadDashboardData();
            await InvokeAsync(StateHasChanged);
        });

        await analyticsHubConnection.StartAsync();
    }

    private async Task InitializeCharts()
    {
        await JSRuntime.InvokeVoidAsync("initializeEngagementChart", "engagementChart");
        await JSRuntime.InvokeVoidAsync("initializeFollowersChart", "followersChart");
    }

    private async Task RefreshData()
    {
        await LoadDashboardData();
        await InitializeCharts();
        StateHasChanged();
    }

    private async Task ChangePeriod(string period)
    {
        selectedPeriod = period;
        await LoadDashboardData();
        StateHasChanged();
    }

    private async Task ExportEngagementChart()
    {
        await JSRuntime.InvokeVoidAsync("exportChart", "engagementChart", "engagement-chart.png");
    }

    private async Task ExportFollowersChart()
    {
        await JSRuntime.InvokeVoidAsync("exportChart", "followersChart", "followers-chart.png");
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Scheduled" => "bg-warning",
        "Published" => "bg-success",
        "Failed" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusText(string status) => status switch
    {
        "Scheduled" => "زمان‌بندی شده",
        "Published" => "منتشر شده",
        "Failed" => "ناموفق",
        _ => "نامشخص"
    };

    private string GetActivityIconClass(string type) => type switch
    {
        "Post" => "bg-primary",
        "Comment" => "bg-info",
        "Like" => "bg-danger",
        "Follow" => "bg-success",
        "Error" => "bg-warning",
        _ => "bg-secondary"
    };

    private string GetActivityIcon(string type) => type switch
    {
        "Post" => "fa-image",
        "Comment" => "fa-comment",
        "Like" => "fa-heart",
        "Follow" => "fa-user-plus",
        "Error" => "fa-exclamation-triangle",
        _ => "fa-info-circle"
    };

    public async ValueTask DisposeAsync()
    {
        if (analyticsHubConnection is not null)
        {
            await analyticsHubConnection.DisposeAsync();
        }
    }
}